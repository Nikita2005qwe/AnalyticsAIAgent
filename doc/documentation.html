<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Документация к программе AnalyticsAIAgent</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <header>
        <h1>Документация к программе <strong>AnalyticsAIAgent</strong></h1>
        <p class="subtitle">AI-агент для автоматизации задач аналитика: создание и перепривязка ТТ, проверка накладных</p>
    </header>

    <nav class="toc">
        <h2>Содержание</h2>
        <ul>
            <li><a href="#section1">1. Цели и актуальность</a></li>
            <li><a href="#section2">2. Модули и классы</a></li>
            <li><a href="#section3">3. Модели данных</a></li>
            <li><a href="#section4">4. Тест-кейсы</a></li>
        </ul>
    </nav>

    <main>

        <!-- === 1. Цели и актуальность === -->
        <section id="section1">
            <h2>1. Цели и актуальность</h2>

            <h3>1.1. Основные цели создания системы</h3>
            <p>
                <strong>AnalyticsAIAgent</strong> разрабатывается как интеллектуальный оркестратор бизнес-процессов, который:
            </p>
            <ul>
                <li>Принимает команды от пользователя в <strong>естественной форме</strong> (текст, голос).</li>
                <li>Понимает намерение и извлекает параметры.</li>
                <li>Автоматизирует выполнение рутинных операций в CRM, DMS и 1С.</li>
                <li>Минимизирует ручной труд, снижает количество ошибок и ускоряет обработку запросов.</li>
            </ul>
            <p>
                <strong>Главная цель — превратить аналитика из исполнителя в контролёра.</strong> Вместо ручного ввода система берёт на себя выполнение, а аналитик контролирует результат.
            </p>

            <h3>1.2. Основные принципы архитектуры</h3>
            <p>Система построена по принципам модульности, устойчивости и расширяемости:</p>
            <table>
                <tr>
                    <th>Принцип</th>
                    <th>Описание</th>
                </tr>
                <tr>
                    <td><strong>AI как оркестратор</strong></td>
                    <td>AI-агент принимает решение, валидирует данные, вызывает нужный процесс и отслеживает результат, но не выполняет действия напрямую.</td>
                </tr>
                <tr>
                    <td><strong>POM (Page Object Model)</strong></td>
                    <td>Все взаимодействия с веб-интерфейсами (CRM, DMS) реализованы через POM, что делает автоматизацию устойчивой к изменениям UI.</td>
                </tr>
                <tr>
                    <td><strong>Разделение operation / process / view</strong></td>
                    <td>
                        <ul>
                            <li><strong>operation</strong> — низкоуровневое действие (например, «ввести адрес»)</li>
                            <li><strong>process</strong> — оркестрация операций (например, «создать точку»)</li>
                            <li><strong>view</strong> — GUI-интерфейс для ручного запуска</li>
                        </ul>
                    </td>
                </tr>
                <tr>
                    <td><strong>Декларативные модели данных</strong></td>
                    <td>Данные о торговых точках, накладных и привязках описываются в JSON. Это обеспечивает масштабируемость и тестируемость.</td>
                </tr>
                <tr>
                    <td><strong>Поддержка ручного и автоматического режимов</strong></td>
                    <td>Система может работать как автономно, так и с участием пользователя (например, при уточнении данных).</td>
                </tr>
            </table>

            <h3>1.3. Типичные сценарии использования</h3>
            <table>
                <tr>
                    <th>Сценарий</th>
                    <th>Описание</th>
                    <th>Частота</th>
                </tr>
                <tr>
                    <td><strong>Создание торговой точки</strong></td>
                    <td>Пользователь загружает JSON с данными → система создаёт ТТ в CRM через Selenium.</td>
                    <td>Ежедневно</td>
                </tr>
                <tr>
                    <td><strong>Массовое создание ТТ</strong></td>
                    <td>Пользователь отправляет файл с 50+ точками → система обрабатывает по одной, логирует ошибки.</td>
                    <td>Раз в 1–2 недели</td>
                </tr>
                <tr>
                    <td><strong>Перепривязка ТТ к ESR</strong></td>
                    <td>Менеджер не видит точку → система находит ТТ по <code>1СТТUID</code>, проверяет <code>XCRM_GUID</code>, обновляет привязку.</td>
                    <td>Ежедневно</td>
                </tr>
                <tr>
                    <td><strong>Проверка выгрузки накладных в DMS</strong></td>
                    <td>Система заходит в DMS, ищет накладные по списку → возвращает статистику: сколько выгружено, сколько нет.</td>
                    <td>Ежедневно</td>
                </tr>
            </table>

            <h3>1.4. Оцениваемые метрики эффективности</h3>
            <p>Реальные показатели на основе практики аналитика:</p>
            <table>
                <tr>
                    <th>Метрика</th>
                    <th>Ручной режим</th>
                    <th>Прогноз (AI-агент)</th>
                    <th>Экономия</th>
                </tr>
                <tr>
                    <td>Время на 1 торговую точку</td>
                    <td>2 минуты</td>
                    <td>15 секунд</td>
                    <td>87.5%</td>
                </tr>
                <tr>
                    <td>Время на 5 точек</td>
                    <td>10 минут</td>
                    <td>1.25 минуты</td>
                    <td>87.5%</td>
                </tr>
                <tr>
                    <td>Время на 56 точек</td>
                    <td>~2 часа</td>
                    <td>~14 минут</td>
                    <td>~87.5%</td>
                </tr>
                <tr>
                    <td>Ошибки при вводе</td>
                    <td>5–10%</td>
                    <td>< 1%</td>
                    <td>в 5–10 раз</td>
                </tr>
                <tr>
                    <td>Повторная обработка из-за "зависших" привязок</td>
                    <td>Часто</td>
                    <td>Редко</td>
                    <td>снижение до 5%</td>
                </tr>
            </table>
            <div class="note">
                Пример: 30.07 было обработано 56 точек. Ручное время — ~2 часа. С AI-агентом — ~14 минут. Экономия: ~1.5 часа.
            </div>
        </section>

        <!-- === 2. Модули и классы === -->
        <section id="section2">
            <h2 id="section2">2. Модули и классы</h2>

            <h3>2.1. Точка входа: <code>main.py</code></h3>
            <p>Точкой входа в приложение является файл <code>main.py</code>, расположенный в корне проекта.</p>
            <p>Он запускает графическое приложение через вызов:</p>
            <pre><code>from src.core.application import Application
            Application().run()</code></pre>
            <p>Для запуска выполните в терминале:</p>
            <pre><code>python main.py</code></pre>
            <p>При старте приложение:</p>
            <ul>
                <li>Инициализирует GUI на базе PyQt5,</li>
                <li>Настраивает вкладки интерфейса,</li>
                <li>Переходит в режим ожидания действий пользователя.</li>
            </ul>
            <p>В случае ошибки запуска проверьте:</p>
            <ul>
                <li>Установлены ли зависимости (<code>PyQt5</code>, <code>selenium</code>, <code>json</code>),</li>
                <li>Соответствует ли структура проекта ожидаемой.</li>
            </ul>

            <h3>2.2. Графический интерфейс: <code>src/core/application.py</code></h3>
            <p>Класс <code>Application</code> — основа GUI. Реализован на базе <code>QMainWindow</code> (PyQt5).</p>
            <p>Отвечает за:</p>
            <ul>
                <li>Создание главного окна приложения,</li>
                <li>Настройку вкладок и элементов интерфейса (поля ввода, кнопки, лог),</li>
                <li>Обработку пользовательских действий,</li>
                <li>Интеграцию с модулями бизнес-логики.</li>
            </ul>

            <h4>2.2.1. Основные вкладки интерфейса</h4>
            <p>Приложение использует вкладки для разделения функциональности:</p>
            <table>
                <tr>
                    <th>Вкладка</th>
                    <th>Описание</th>
                </tr>
                <tr>
                    <td><strong>Чат с AI-агентом</strong></td>
                    <td>Текстовое поле для ввода запроса пользователя. Ответ ИИ отображается в чате. Дополнительно — поле с полным логом выполнения.</td>
                </tr>
                <tr>
                    <td><strong>Создание торговых точек</strong></td>
                    <td>Поле для загрузки JSON-файла с данными о ТТ (см. раздел 3). Кнопка «Запустить создание».</td>
                </tr>
                <tr>
                    <td><strong>Перепривязка ТТ</strong></td>
                    <td>Поле для загрузки списка ТТ (с указанием <code>1СТТUID</code> и целевой ESR). Кнопка «Запустить перепривязку».</td>
                </tr>
                <tr>
                    <td><strong>Проверка накладных</strong></td>
                    <td>Поле для загрузки списка номеров накладных (JSON или TXT). Кнопка «Запустить проверку».</td>
                </tr>
                <tr>
                    <td><strong>Настройки</strong></td>
                    <td>Редактирование параметров: URL CRM, DMS, пути к файлам, таймауты. Сохранение в <code>settings.json</code>.</td>
                </tr>
            </table>

            <h4>2.2.2. Элементы интерфейса</h4>
            <ul>
                <li><strong>Поле ввода сообщения</strong> — для текстовых команд AI-агенту (например, «Создай точку 0206329»).</li>
                <li><strong>Окно чата</strong> — отображает запрос пользователя и ответ ИИ.</li>
                <li><strong>Поле лога</strong> — подробный вывод всех шагов, ошибок, статусов (например, «Точка 0206329 создана в CRM»).</li>
                <li><strong>Кнопки запуска процессов</strong> — для ручного запуска операций без использования чата.</li>
                <li><strong>Контроли загрузки файлов</strong> — кнопки «Загрузить JSON», «Выбрать файл».</li>
            </ul>

            <h4>2.2.3. Обработчики событий</h4>
            <p>Класс <code>Application</code> содержит методы для обработки действий пользователя:</p>
            <table>
                <tr>
                    <th>Метод</th>
                    <th>Описание</th>
                </tr>
                <tr>
                    <td><code>_on_ai_message()</code></td>
                    <td>Обрабатывает ввод в чате. Передаёт текст в AI-агент для анализа и запуска процесса.</td>
                </tr>
                <tr>
                    <td><code>_on_create_single()</code></td>
                    <td>Запускает процесс создания одной ТТ (через ручной ввод или GUI).</td>
                </tr>
                <tr>
                    <td><code>_on_bulk_create()</code></td>
                    <td>Запускает массовое создание ТТ из JSON-файла.</td>
                </tr>
                <tr>
                    <td><code>_on_rebind_single()</code></td>
                    <td>Запускает перепривязку одной ТТ.</td>
                </tr>
                <tr>
                    <td><code>_on_bulk_rebind()</code></td>
                    <td>Запускает массовую перепривязку ТТ из загруженного файла.</td>
                </tr>
                <tr>
                    <td><code>_on_check_invoices()</code></td>
                    <td>Запускает процесс проверки накладных в DMS.</td>
                </tr>
                <tr>
                    <td><code>_on_settings_save()</code></td>
                    <td>Сохраняет настройки в <code>settings.json</code>.</td>
                </tr>
            </table>

            <h4>2.2.4. Зависимости</h4>
            <ul>
                <li><code>PyQt5</code> — для построения GUI.</li>
                <li><code>src.business_processes.*</code> — для вызова бизнес-процессов (<code>create_tt</code>, <code>rebind_tt</code>, <code>check_invoices</code>).</li>
                <li><code>src.config.settings</code> — для доступа к настройкам приложения.</li>
            </ul>

            <h3>2.3. POMs (Page Object Model)</h3>
            <p>Модуль <code>src/pages/</code> содержит классы для взаимодействия с веб-интерфейсами через Selenium.</p>
            <p>AI-агент работает в трёх системах:</p>
            <ul>
                <li><strong>DMS</strong> — проверка выгрузки накладных,</li>
                <li><strong>CRM</strong> — создание и привязка торговых точек,</li>
                <li><strong>1С</strong> — чтение данных (в будущем).</li>
            </ul>

            <h4>2.3.1. Структура POM</h4>
            <pre>
            src/pages/
            ├── dms/
            │   ├── login_page.py
            │   ├── distributor_panel.py
            │   └── documents_page.py
            ├── crm/
            │   ├── login_page.py
            │   ├── organization_page.py
            │   └── binding_page.py
            └── one_s/
                └── data_reader_page.py (в будущем)
            </pre>

            <h4>2.3.2. Пример: Проверка накладных в DMS</h4>
            <ol>
                <li>Запуск браузера.</li>
                <li>Авторизация на <code>good food shop</code>.</li>
                <li>Вход в панель дистрибьютора.</li>
                <li>Переход в раздел «Документы».</li>
                <li>Для каждой накладной из списка:
                    <ul>
                        <li>Ввод номера в поле поиска,</li>
                        <li>Ожидание загрузки результата,</li>
                        <li>Фиксация статуса: «выгружена» / «не выгружена».</li>
                    </ul>
                </li>
                <li>Формирование итоговой статистики и списка невыгруженных накладных.</li>
            </ol>

            <h3>2.4. Бизнес-логика: <code>src/business_processes/</code></h3>
            <p>Модуль содержит процессы, которые выполняет аналитик. Каждый процесс следует единому паттерну:</p>
            <ul>
                <li><strong>operation.py</strong> — низкоуровневые действия (например, «найти ТТ в CRM»),</li>
                <li><strong>process.py</strong> — оркестрация полного бизнес-процесса,</li>
                <li><strong>view.py</strong> — опционально, GUI-элементы для ручного запуска (например, кнопки, поля).</li>
            </ul>

            <h4>2.4.1. Общий интерфейс <code>process.py</code></h4>
            <p>Каждый процесс реализует следующие методы:</p>
            <table>
                <tr>
                    <th>Метод</th>
                    <th>Описание</th>
                </tr>
                <tr>
                    <td><code>run()</code></td>
                    <td>Запускает выполнение процесса. Вызывает операции последовательно.</td>
                </tr>
                <tr>
                    <td><code>validate()</code></td>
                    <td>Проверяет, все ли входные данные известны. Если нет — возвращает список недостающих полей.</td>
                </tr>
                <tr>
                    <td><code>load_data(data)</code></td>
                    <td>Загружает входные данные (например, JSON-файл или данные из чата).</td>
                </tr>
                <tr>
                    <td><code>get_results()</code></td>
                    <td>Возвращает результаты процесса в структурированном виде (например, статистику, список ошибок).</td>
                </tr>
            </table>

            <h4>2.4.2. Пример: <code>check_invoices</code></h4>
            <ul>
                <li><strong>Назначение:</strong> Проверка выгрузки накладных в DMS.</li>
                <li><strong>Входные данные:</strong> Список номеров накладных (список строк).</li>
                <li><strong>Процесс:</strong>
                    <ol>
                        <li>Загрузка данных через <code>load_data()</code>.</li>
                        <li>Валидация: проверка, что список не пуст.</li>
                        <li>Для каждой накладной — вызов <code>CheckInvoiceOperation</code>.</li>
                        <li>Сбор статистики.</li>
                    </ol>
                </li>
                <li><strong>Выходные данные:</strong>
                    <ul>
                        <li>Количество выгруженных,</li>
                        <li>Количество невыгруженных,</li>
                        <li>Список накладных для ручной проверки.</li>
                    </ul>
                </li>
            </ul>

            <h4>2.4.3. Пример: <code>create_tt</code></h4>
            <ul>
                <li><strong>Назначение:</strong> Создание одной или нескольких торговых точек в CRM.</li>
                <li><strong>Входные данные:</strong> JSON-объект или список объектов <code>TradePoint</code> (см. раздел 3).</li>
                <li><strong>Процесс:</strong>
                    <ol>
                        <li>Загрузка данных из файла или ввода.</li>
                        <li>Валидация обязательных полей.</li>
                        <li>Для каждой точки — вызов <code>CreateTradePointOperation</code>.</li>
                        <li>Логирование успеха/ошибки.</li>
                    </ol>
                </li>
                <li><strong>Выходные данные:</strong> Отчёт о созданных и не созданных точках.</li>
            </ul>

            <h4>2.4.4. Пример: <code>rebind_tt</code></h4>
            <ul>
                <li><strong>Назначение:</strong> Перепривязка ТТ к новой территории ESR.</li>
                <li><strong>Входные данные:</strong> Список с <code>1СТТUID</code> и целевым <code>GC_...</code>.</li>
                <li><strong>Процесс:</strong>
                    <ol>
                        <li>Поиск <code>XCRM_GUID</code> в 1С (или через локальный JSON).</li>
                        <li>Если нет — запуск <code>create_tt</code> для создания новой организации.</li>
                        <li>Если есть — поиск ТТ в CRM.</li>
                        <li>Поиск целевой ESR по имени (например, <code>GC_Абакан Н55_esr</code>).</li>
                        <li>Деактивация старой привязки (если есть).</li>
                        <li>Создание новой привязки (даже если территория та же — для запуска синхронизации).</li>
                    </ol>
                </li>
                <li><strong>Выходные данные:</strong> Подтверждение: «Точка будет отображаться у ESR».</li>
            </ul>
        </section>

        <!-- === 3. Модели данных === -->
        <section id="section3">
            <h2>3. Модели данных</h2>
            <p>См. предыдущую версию — содержание сохранено.</p>
        </section>

        <!-- === 4. Тест-кейсы === -->
        <section id="section4">
            <h2>4. Тест-кейсы</h2>
            <p>В разработке.</p>
        </section>

    </main>

    <footer>
        Документация к программе AnalyticsAIAgent<br>
        Последнее обновление: 1 августа 2025 г.<br>
        Разработчик: Боряков Никита Андреевич<br>
        Готово к правкам и дополнениям.
    </footer>

</body>
</html>