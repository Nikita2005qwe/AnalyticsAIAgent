"""
–ú–æ–¥—É–ª—å: process.py
–û–ø–∏—Å–∞–Ω–∏–µ: –ü—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö –∏–∑ Excel-—Ñ–∞–π–ª–∞.

–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–Ω—ã–º —Ü–∏–∫–ª–æ–º –ø—Ä–æ–≤–µ—Ä–∫–∏:
  - –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–º–µ—Ä–æ–≤ —á–µ—Ä–µ–∑ FileService,
  - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞–º,
  - –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º,
  - –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞,
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö –∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ FileService.
- –ù–µ –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç –¥–µ—Ç–∞–ª–µ–π —Ä–∞–±–æ—Ç—ã —Å Excel.
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å FileService –∫–∞–∫ –µ–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫ —Ñ–∞–π–ª–∞–º.

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Ä–æ–ª—å:
- –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä: —É–ø—Ä–∞–≤–ª—è–µ—Ç –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –ø—Ä–æ–≤–µ—Ä–∫–∏.
- –ö–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç: FileService ‚Üí InvoiceSearchOperation ‚Üí FileService.
- –ù–µ –∑–Ω–∞–µ—Ç, –∫–∞–∫ —á–∏—Ç–∞—Ç—å/–ø–∏—Å–∞—Ç—å Excel ‚Äî —Ç–æ–ª—å–∫–æ —á—Ç–æ –∏ –∫–æ–≥–¥–∞.

–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
- InvoiceSearchOperation (–æ–ø–µ—Ä–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞)
- Logger (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
- FileService (—Ä–∞–±–æ—Ç–∞ —Å Excel)
- models.invoice: Invoice, InvoiceFactory, should_process
"""
from datetime import datetime
from tarfile import data_filter
# --- –ò–º–ø–æ—Ä—Ç—ã –∏–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ ---
from typing import List, Tuple

# --- –ò–º–ø–æ—Ä—Ç—ã –∏–∑ src ---
from src.core.logger import Logger
from src.core.config import Config
from .operation import InvoiceSearchOperation
from .report import ReporterOfCheckInvoiceProcess

# --- –ò–º–ø–æ—Ä—Ç—ã –∏–∑ —Å–µ—Ä–≤–∏—Å–æ–≤ ---
from src.services.file_handler import FileHandler

# --- –ò–º–ø–æ—Ä—Ç—ã –∏–∑ –º–æ–¥–µ–ª–µ–π ---
from src.models.invoice.invoice_factory import InvoiceFactory
from src.models.invoice.invoice_validation import FilterInvoices


class InvoiceCheckerProcess:
    """
    –ü—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö –∏–∑ Excel-—Ñ–∞–π–ª–∞.

    –ê—Ç—Ä–∏–±—É—Ç—ã:
    - logger (Logger): –î–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Ö–æ–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    - file_service (FileService): –î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è Excel
    - factory (InvoiceFactory): –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ Invoice
    """

    def __init__(self, logger: Logger, config: Config):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–≤–µ—Ä–∫–∏.

        Args:
            logger (Logger): –≠–∫–∑–µ–º–ø–ª—è—Ä –ª–æ–≥–≥–µ—Ä–∞

        –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:
        - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π: FileService —Å–æ–∑–¥–∞—ë—Ç—Å—è –≤–Ω–µ –ø—Ä–æ—Ü–µ—Å—Å–∞.
        - –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ª–µ–≥–∫–æ –∑–∞–º–µ–Ω—è—Ç—å –∏–ª–∏ –º–æ–∫–∞—Ç—å FileService –≤ —Ç–µ—Å—Ç–∞—Ö.
        """
        self.invoices = []
        self.logger = logger
        self.file_handler = None
        self.factory = InvoiceFactory()
        self.filter = FilterInvoices()
        self.reporter = None
        self.config = config
        self.operator = None

    def run(self, file_path: str) -> None:
        """
        –ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö –∏–∑ Excel-—Ñ–∞–π–ª–∞.

        –≠—Ç–æ **—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥** –≤—Å–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞. –û–Ω:
        - –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ,
        - –§–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞–º,
        - –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º,
        - –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–∫–ª–∞–¥–Ω—ã–µ –≤ DMS (—á–µ—Ä–µ–∑ InvoiceSearchOperation),
        - –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã,
        - –û–±–Ω–æ–≤–ª—è–µ—Ç Excel-—Ñ–∞–π–ª —Å —Ü–≤–µ—Ç–æ–≤–æ–π –∑–∞–ª–∏–≤–∫–æ–π,
        - –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –æ—Ç—á—ë—Ç –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.

        –ì–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å ‚Äî **–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª—è–µ–º–æ—Å—Ç—å**:
        - –î–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –±—É–¥–µ—Ç –ø—Ä–µ—Ä–≤–∞–Ω (–æ—à–∏–±–∫–∞, –∑–∞–∫—Ä—ã—Ç–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞, —Å–±–æ–π),
          **–≤—Å–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ –±—É–¥—É—Ç –æ—Ç–º–µ—á–µ–Ω—ã –≤ —Ñ–∞–π–ª–µ**.
        - –ù–∏–∫–∞–∫–∞—è —Ä–∞–±–æ—Ç–∞ –Ω–µ —Ç–µ—Ä—è–µ—Ç—Å—è.

        Args:
            file_path (str): –ü—É—Ç—å –∫ Excel-—Ñ–∞–π–ª—É —Å –Ω–æ–º–µ—Ä–∞–º–∏ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö

        Returns:
            List[Tuple[str, bool, str]]: –°–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
                (–Ω–æ–º–µ—Ä_–Ω–∞–∫–ª–∞–¥–Ω–æ–π, –Ω–∞–π–¥–µ–Ω–∞, —Å—Ç–∞—Ç—É—Å)
                –≥–¥–µ —Å—Ç–∞—Ç—É—Å:
                    - "found" ‚Äî –Ω–∞–π–¥–µ–Ω–∞
                    - "not_found" ‚Äî –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
                    - "error" ‚Äî –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ
                    - "unknown" ‚Äî –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–µ—Ñ–∏–∫—Å
                    - "skipped" ‚Äî –ø—Ä–æ–ø—É—â–µ–Ω–∞ (–Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Ñ–∏–ª—å—Ç—Ä)

        –®–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

        1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:**
           - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ file_path –Ω–µ –ø—É—Å—Ç–æ–π –∏ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
           - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ sheet_name –≤—Ö–æ–¥–∏—Ç –≤ –¥–æ–ø—É—Å—Ç–∏–º—ã–µ (–µ—Å–ª–∏ –µ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è)
           - –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ ‚Äî –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å, –≤–µ—Ä–Ω—É—Ç—å –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫

        2. **–ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ Invoice:**
           - –í—ã–∑–≤–∞—Ç—å self._load_invoices_from_excel(file_path, sheet_name)
           - –ú–µ—Ç–æ–¥ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç List[Invoice] —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏:
               - number
               - prefix
               - region
               - isa_amount, sfa_amount
           - –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è ‚Äî –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å, –≤–µ—Ä–Ω—É—Ç—å []

        3. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞–º:**
           - –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö should_process(invoice) == True
           - –û—Å—Ç–∞–ª—å–Ω—ã–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ISA=0) ‚Äî –ø–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ "skipped", –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å
           - –ó–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å: "–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: 120 ‚Üí 85 –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö"

        4. **–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º:**
           - –†–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞:
               - siberia: [inv for inv in invoices if inv.region == "siberia"]
               - ural: [inv for inv in invoices if inv.region == "ural"]
               - unknown: –æ—Å—Ç–∞–ª—å–Ω—ã–µ (–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–µ—Ñ–∏–∫—Å)
           - –ó–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø–µ

        5. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–≥–∏–æ–Ω–∞ "siberia":**
           - –ï—Å–ª–∏ –≥—Ä—É–ø–ø–∞ –Ω–µ –ø—É—Å—Ç–∞:
               a. –°–æ–∑–¥–∞—Ç—å InvoiceSearchOperation("siberia", logger=self.logger)
               b. –í—ã–∑–≤–∞—Ç—å op.start() ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Å—Å–∏—é
               c. –î–ª—è –∫–∞–∂–¥–æ–π –Ω–∞–∫–ª–∞–¥–Ω–æ–π –≤ –≥—Ä—É–ø–ø–µ:
                   - –í—ã–∑–≤–∞—Ç—å op.check_invoice(invoice.number)
                   - –û–±–Ω–æ–≤–∏—Ç—å invoice.found_in_dms –∏ status
                   - –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫ self.temp_results
                   - –ó–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ö–æ–¥: "‚Üí 01/12345: ‚úÖ"
               d. –ü–æ—Å–ª–µ –≤—Å–µ—Ö ‚Äî –≤—ã–∑–≤–∞—Ç—å self._mark_excel_partial(file_path, sheet_name, self.temp_results)
                   * –≠—Ç–æ **–∫–ª—é—á–µ–≤–æ–π —à–∞–≥**: —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –°–∏–±–∏—Ä–∏ **–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ñ–∞–π–ª**
                   * –î–∞–∂–µ –µ—Å–ª–∏ –¥–∞–ª—å—à–µ –±—É–¥–µ—Ç –æ—à–∏–±–∫–∞ ‚Äî —ç—Ç–∏ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —É–∂–µ –æ—Ç–º–µ—á–µ–Ω—ã
               e. –í—ã–∑–≤–∞—Ç—å op.close() ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–∫—Ä—ã—Ç—å –±—Ä–∞—É–∑–µ—Ä

        6. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–≥–∏–æ–Ω–∞ "ural":**
           - –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ:
               a. –°–æ–∑–¥–∞—Ç—å op = InvoiceSearchOperation("ural", ...)
               b. start()
               c. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ
               d. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: _mark_excel_partial
               e. close()

        7. **–û–±—Ä–∞–±–æ—Ç–∫–∞ "unknown" (–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–µ—Ñ–∏–∫—Å—ã):**
           - –î–ª—è –∫–∞–∂–¥–æ–π –Ω–∞–∫–ª–∞–¥–Ω–æ–π:
               - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å status = "unknown"
               - found_in_dms = False
               - –î–æ–±–∞–≤–∏—Ç—å –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
           - –í —Ñ–∞–π–ª–µ –±—É–¥–µ—Ç –ø–æ–¥—Å–≤–µ—á–µ–Ω–∞ –∫–∞–∫ FILL_NOT_SEARCHED (–∂—ë–ª—Ç—ã–π)
           - –ù–µ –ø—ã—Ç–∞–µ–º—Å—è –ø—Ä–æ–≤–µ—Ä—è—Ç—å ‚Äî –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö

        8. **–§–∏–Ω–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Excel:**
           - –í—ã–∑–≤–∞—Ç—å self._mark_excel_partial() **–µ—â—ë —Ä–∞–∑** ‚Äî –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –ø–æ—Å–ª–µ –£—Ä–∞–ª–∞ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
           - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ —è—á–µ–π–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã

        9. **–û—Ç–∫—Ä—ã—Ç–∏–µ –æ—Ç—á—ë—Ç–Ω–æ–≥–æ —Ñ–∞–π–ª–∞:**
           - –í—ã–∑–≤–∞—Ç—å self._save_and_open_report(file_path)
           - –ú–µ—Ç–æ–¥:
               * –£–±–µ–¥–∏—Ç—Å—è, —á—Ç–æ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
               * –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –æ—Ç–∫—Ä—ã—Ç—å –µ–≥–æ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π:
                   - Windows: os.startfile(file_path)
                   - macOS: subprocess.run(['open', file_path])
                   - Linux: subprocess.run(['xdg-open', file_path])
               * –ó–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å: "üìÑ –û—Ç—á—ë—Ç –æ—Ç–∫—Ä—ã—Ç: {file_path}"
               * –ü—Ä–∏ –æ—à–∏–±–∫–µ ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –Ω–µ –æ—à–∏–±–∫–∞

        10. **–§–∏–Ω–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
            - –ü–æ–¥—Å—á–∏—Ç–∞—Ç—å:
                - found = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å status == "found"
                - not_found = "not_found"
                - errors = "error"
                - unknown = "unknown"
            - –ó–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∏—Ç–æ–≥:
                "‚úÖ –ì–æ—Ç–æ–≤–æ: –Ω–∞–π–¥–µ–Ω–æ=15, –Ω–µ –Ω–∞–π–¥–µ–Ω–æ=3, –æ—à–∏–±–∫–∏=2, –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ=1"
                "üé® –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∏ —Ñ–∞–π–ª –æ—Ç–∫—Ä—ã—Ç"

        11. **–í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:**
            - –í–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            - –ú–æ–∂–µ—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω AI-–∞–≥–µ–Ω—Ç–æ–º, —Ç–µ—Å—Ç–∞–º–∏, –ª–æ–≥–∏–∫–æ–π

        –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:

        - –í—Å–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è (–≤–∫–ª—é—á–∞—è –ø–∞–¥–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞, —Ç–∞–π–º–∞—É—Ç, –æ—à–∏–±–∫–∞ Excel) ‚Äî –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—é—Ç—Å—è
        - –ü—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª):
            * –ó–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å
            * –í–µ—Ä–Ω—É—Ç—å –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
        - –ü—Ä–∏ —á–∞—Å—Ç–∏—á–Ω–æ–π –æ—à–∏–±–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —É–ø–∞–ª –±—Ä–∞—É–∑–µ—Ä –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ):
            * –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å _recover_session()
            * –ò–ª–∏ –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ä–µ–≥–∏–æ–Ω—É
            * –£–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ ‚Äî —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã

        –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:

        - ‚úÖ **–ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ**: –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ñ–∞–π–ª
        - ‚úÖ **–£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å**: –Ω–µ –ø–∞–¥–∞–µ—Ç –∏–∑-–∑–∞ –æ–¥–Ω–æ–π –Ω–∞–∫–ª–∞–¥–Ω–æ–π
        - ‚úÖ **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏**: –µ—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –∑–∞–∫—Ä—ã—Ç ‚Äî –ø—ã—Ç–∞–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
        - ‚úÖ **–û—Ç–∫—Ä—ã—Ç–∏–µ —Ñ–∞–π–ª–∞**: –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è ‚Äî —Ñ–∞–π–ª –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        - ‚úÖ **–ü–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–µ–ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö**: –Ω–∞–∫–ª–∞–¥–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –±—ã–ª–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è),
          –æ—Å—Ç–∞—é—Ç—Å—è —Å –±–µ–ª–æ–π –∑–∞–ª–∏–≤–∫–æ–π (FILL_NOT_CHECKED), —á—Ç–æ –≤–∏–∑—É–∞–ª—å–Ω–æ –æ—Ç–ª–∏—á–∞–µ—Ç –∏—Ö –æ—Ç "–Ω–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö"
        - ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥–æ–º–µ–Ω–æ–º**: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Invoice, –ø—Ä–∞–≤–∏–ª–∞, —Ñ–∞–±—Ä–∏–∫—É, —Å—Ç–∏–ª—å

        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç:
        - self._load_invoices_from_excel() ‚Üí –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        - should_process() ‚Üí —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
        - InvoiceSearchOperation ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞
        - self._mark_excel_partial() ‚Üí –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        - self._save_and_open_report() ‚Üí UX
        - Logger ‚Üí –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ö–æ–¥–∞ –∏ –æ—à–∏–±–æ–∫

        –ü—Ä–∏–º–µ—Ä –≤—ã–∑–æ–≤–∞:
            results = process.run("data/invoices.xlsx", "–≤—ã–≥—Ä—É–∑–∫–∞_GC")
            # ‚Üí [(...), ...], —Ñ–∞–π–ª –æ–±–Ω–æ–≤–ª—ë–Ω –∏ –æ—Ç–∫—Ä—ã—Ç
        """
        data_for_report = []
        start_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        self.logger.info(f"–ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞ ‚Äî {start_time}")
        self.file_handler = FileHandler(file_path)
        # –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –Ω–∞–∫–ª–∞–¥–Ω—ã–º —Å–æ –≤—Å–µ—Ö –ª–∏—Å—Ç–æ–≤ –∫–∞–∫ –æ–ø–∏—Å–∞–Ω–æ –≤ —ç–∫–∑–µ–º–ø–ª—è—Ä–µ file_handler
        for sheet_name in ["–º–æ–π –∫—É–± GC","–º–æ–π –∫—É–± BF","–º–æ–π –∫—É–± PU"]:
            self.invoices.extend(self.file_handler.read_invoices(sheet_name))
        # –§–∏–ª—å—Ç—Ä—É–µ–º —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ —É—Å–ª–æ–≤–∏—è–º
        self.invoices = self.filter.filter_invoices(self.invoices)
        # –°–æ–±–∏—Ä–∞–µ–º –∏–∑ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞–∫–ª–∞–¥–Ω—ã–µ
        self.invoices = self.factory.create_invoices(self.invoices)

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –°–∏–±–∏—Ä–∏
        self.process_invoices_by_region("siberia", data_for_report)

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –£—Ä–∞–ª–∞
        self.process_invoices_by_region("ural", data_for_report)

        self.reporter = ReporterOfCheckInvoiceProcess("data/report_of_checking_invoices.xlsx",
                                                      data_for_report,
                                                      logger=self.logger)
        self.reporter.create_report()

        end_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        self.logger.info(f"–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ ‚Äî {end_time}")
        duration = datetime.strptime(end_time, "%Y-%m-%d %H:%M:%S") - datetime.strptime(start_time, "%Y-%m-%d %H:%M:%S")
        self.logger.info(f"‚è±Ô∏è –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {duration}")

        self.reporter.open_report()

    def process_invoices_by_region(self, region: str, data_for_report: list):
        """
        –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∫–ª–∞–¥–Ω—ã–µ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞.

        –í—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:
        1. –§–∏–ª—å—Ç—Ä—É–µ—Ç –Ω–∞–∫–ª–∞–¥–Ω—ã–µ –ø–æ —Ä–µ–≥–∏–æ–Ω—É.
        2. –°–æ–∑–¥–∞—ë—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö (InvoiceSearchOperation).
        3. –ó–∞–ø—É—Å–∫–∞–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä.
        4. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∂–¥—É—é –Ω–∞–∫–ª–∞–¥–Ω—É—é –∏–∑ —Ä–µ–≥–∏–æ–Ω–∞.
        5. –î–æ–±–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫ data_for_report.

        :param region: –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "siberia", "ural")
        :param data_for_report: –°–ø–∏—Å–æ–∫, –≤ –∫–æ—Ç–æ—Ä—ã–π –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö
        """
        # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É —Ä–µ–≥–∏–æ–Ω—É
        filtered_invoices = [invoice for invoice in self.invoices if invoice.region == region]

        # –°–æ–∑–¥–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–∞–∫–ª–∞–¥–Ω—ã–º–∏ –≤ –¥–∞–Ω–Ω–æ–º —Ä–µ–≥–∏–æ–Ω–µ
        operator = InvoiceSearchOperation(region, self.logger, self.config)

        # –ó–∞–ø—É—Å–∫ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ (–≤–æ–∑–º–æ–∂–Ω–æ, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è, –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ —Ç.–ø.)
        operator.start()

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥–æ–π –Ω–∞–∫–ª–∞–¥–Ω–æ–π –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ –æ–±—â–∏–π –æ—Ç—á—ë—Ç
        try:
            for invoice in filtered_invoices:
                checked_invoice = operator.check_invoice(invoice)
                data_for_report.append(checked_invoice)
        finally:
            operator.close()  # –í—ã–∑–æ–≤–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞